name: Sync master to master-jdk21
on:
  push:
    branches:
      - master

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check for master-jdk21 branch
        id: check-branch
        run: |
          git fetch origin || true
          if git ls-remote --heads origin master-jdk21 | grep master-jdk21; then
            echo "Branch exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Branch does not exist"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create master-jdk21 branch if needed
        if: steps.check-branch.outputs.exists == 'false'
        run: |
          git checkout -b master-jdk21
          git push origin master-jdk21
      
      - name: Create/update sync branch
        run: |
          git checkout -b sync-branch
          git push -f origin sync-branch:sync/master-to-master-jdk21
      
      - name: Create Pull Request using curl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          PR_CHECK=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls?head=$GITHUB_REPOSITORY_OWNER:sync/master-to-master-jdk21&base=master-jdk21&state=open")
          
          if [[ $(echo $PR_CHECK | jq length) -eq 0 ]]; then
            # Create PR
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$GITHUB_REPOSITORY/pulls \
              -d '{
                "title": "Sync: master to master-jdk21",
                "body": "Automated PR to sync changes from master to master-jdk21",
                "head": "sync/master-to-master-jdk21",
                "base": "master-jdk21"
              }'
            echo "Pull request created"
          else
            echo "Pull request already exists"
          fi